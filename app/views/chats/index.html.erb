<div class="h-screen flex bg-gray-100" data-controller="chat" data-chat-agent-id="<%= @agent.id %>" data-chat-id="<%= @chat&.id %>">
  <!-- Sidebar com lista de chats -->
  <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
    <!-- Header do sidebar -->
    <div class="p-4 border-b border-gray-200 bg-gray-50">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
            <span class="text-white font-semibold text-sm"><%= @agent.name.first.upcase %></span>
          </div>
          <div>
            <h3 class="font-semibold text-gray-900"><%= @agent.name %></h3>
            <p class="text-xs text-gray-500"><%= pluralize(@chats.count, 'conversa') %></p>
          </div>
        </div>
        <%= link_to workspace_agent_chats_path(@agent.workspace, @agent), method: :post, params: { chat: { title: '' } }, class: "p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors", title: "Novo Chat" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
        <% end %>
      </div>
    </div>

    <!-- Lista de chats -->
    <div class="flex-1 overflow-y-auto">
      <% @chats.each do |chat| %>
        <div class="<%= 'bg-blue-50 border-r-4 border-blue-500' if chat == @chat %>">
          <%= link_to workspace_agent_chat_path(@agent.workspace, @agent, chat), class: "flex items-start p-4 hover:bg-gray-50 transition-colors border-b border-gray-100 block" do %>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-medium text-gray-900 truncate">
                  <%= chat.title %>
                </h4>
                <span class="text-xs text-gray-500">
                  <%= time_ago_in_words(chat.updated_at) %>
                </span>
              </div>
              <p class="text-sm text-gray-600 mt-1 truncate">
                <%= chat.preview_message if chat.respond_to?(:preview_message) %>
              </p>
            </div>
          <% end %>
          
          <% if chat == @chat %>
            <div class="px-4 pb-2">
              <%= link_to workspace_agent_chat_path(@agent.workspace, @agent, chat), method: :delete, 
                  confirm: 'Tem certeza que deseja excluir este chat?',
                  class: "text-xs text-red-600 hover:text-red-800" do %>
                üóëÔ∏è Excluir chat
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <% if @chats.empty? %>
        <div class="p-8 text-center text-gray-500">
          <p class="text-sm">Nenhuma conversa ainda</p>
          <p class="text-xs mt-1">Clique no + para iniciar</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- √Årea principal do chat -->
  <div class="flex-1 flex flex-col">
    <% if @chat %>
      <!-- Header do chat -->
      <div class="bg-white border-b border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
              <span class="text-white text-xs font-semibold">AI</span>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900"><%= @chat.title %></h3>
              <p class="text-xs text-gray-500">Conversa com <%= @agent.name %></p>
            </div>
          </div>
          
          <div class="flex items-center space-x-2">
            <%= link_to workspace_agent_chats_path(@agent.workspace, @agent), method: :post, params: { chat: { title: '' } }, 
                class: "px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors" do %>
              Novo Chat
            <% end %>
          </div>
        </div>
      </div>

      <!-- √Årea de mensagens -->
      <div class="flex-1 overflow-y-auto bg-gray-50 p-4" data-chat-target="messages" style="background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><defs><pattern id=\"grain\" width=\"100\" height=\"100\" patternUnits=\"userSpaceOnUse\"><circle cx=\"50\" cy=\"50\" r=\"0.5\" fill=\"%23f3f4f6\" opacity=\"0.1\"/></pattern></defs><rect width=\"100\" height=\"100\" fill=\"url(%23grain)\"/></svg>');">
        <div class="space-y-4 pb-4">
          <% @messages.each do |message| %>
            <div class="flex <%= message.role == 'user' ? 'justify-end' : 'justify-start' %>">
              <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg <%= message.role == 'user' ? 'bg-blue-500 text-white' : 'bg-white text-gray-900 shadow-sm' %>">
                <div class="text-sm">
                  <%= simple_format(message.content) %>
                </div>
                <div class="text-xs mt-1 <%= message.role == 'user' ? 'text-blue-100' : 'text-gray-500' %>">
                  <%= message.created_at.strftime('%H:%M') %>
                </div>
              </div>
            </div>
          <% end %>
          
          <% if @messages.empty? %>
            <div class="text-center py-12">
              <div class="w-16 h-16 bg-gray-300 rounded-full mx-auto mb-4 flex items-center justify-center">
                <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">Iniciar Conversa</h3>
              <p class="text-gray-600 mb-4">Envie uma mensagem para come√ßar a conversar com <%= @agent.name %></p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- √Årea de input -->
      <div class="bg-white border-t border-gray-200 p-4">
        <%= form_with url: workspace_agent_chat_messages_path(@agent.workspace, @agent, @chat), local: false, 
            data: { chat_target: 'form' }, class: "flex items-end space-x-3" do |form| %>
          <div class="flex-1">
            <%= form.text_area :content, 
                placeholder: "Digite sua mensagem...", 
                rows: 1,
                class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",
                data: { chat_target: 'input' } %>
          </div>
          <%= form.submit "Enviar", 
              class: "px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors",
              data: { chat_target: 'submit' } %>
        <% end %>
      </div>
    <% else %>
      <!-- Estado vazio quando n√£o h√° chats -->
      <div class="flex-1 flex items-center justify-center bg-gray-50">
        <div class="text-center">
          <div class="w-24 h-24 bg-gray-300 rounded-full mx-auto mb-6 flex items-center justify-center">
            <svg class="w-12 h-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-medium text-gray-900 mb-2">Bem-vindo ao <%= @agent.name %></h3>
          <p class="text-gray-600 mb-6">Clique no bot√£o + no sidebar para iniciar uma nova conversa</p>
          <%= link_to workspace_agent_chats_path(@agent.workspace, @agent), method: :post, params: { chat: { title: '' } }, 
              class: "inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Iniciar Chat
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>